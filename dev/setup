#!/usr/bin/env bash

export PATH=/bin:/usr/local/bin:$PATH

cd /app

echo "-|| Setting base URL"
echo $MAGENTO_URL
bin/magento config:set web/unsecure/base_url ${MAGENTO_URL}/ \
|| mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE -e "update core_config_data set value = '$MAGENTO_URL/' where path = 'web/unsecure/base_url';"


echo "-|| Configuring Coding Standard"
vendor/bin/phpcs --config-set installed_paths ../../magento/magento-coding-standard/

echo "-|| Install plugin..."
if [[ ! $(bin/magento module:status | grep Emartech_Emarsys) ]]
then
  echo "   >> Installing plugin"
  php /opt/emartech/composer-config.php ./composer.json add_local_plugin
  composer dump-autoload
  bin/magento setup:upgrade | grep -A 1 "Emartech"
else
  echo "   >> Skipping installation."
fi

echo "-|| Creating EAV fields"
bin/magento emartech:attribute:create

echo "-|| Setting EAV field for customer 1"
bin/magento emartech:customer-attribute:set --customer_id 1 --attribute_name emarsys_test_favorite_car --attribute_value ferrari

echo "-|| Setting website configuration"
mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE -e "INSERT INTO store_website (code, name, default_group_id) VALUES ('second','Second Site',2);"
mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE -e "INSERT INTO store_group (website_id, root_category_id,name,code) VALUES (2,2,'Second Store','second_store');"
mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE -e "INSERT INTO store (code,website_id,group_id,name,is_active) VALUES ('second_storeview',2,2,'Second Store View',1);"
mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE -e "INSERT INTO store (code,website_id,group_id,name,is_active) VALUES ('custom_storeview',1,1,'Custom Store View',1);"
echo "-|| Setting admin security configuration"
mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE -e "INSERT INTO core_config_data (scope, scope_id, path, value) VALUES ('default', 0, 'admin/security/session_lifetime', '86400');"
mysql -h $MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE -e "INSERT INTO core_config_data (scope, scope_id, path, value) VALUES ('default', 0, 'admin/security/password_lifetime', '900');"

echo "-|| Running indexer"
bin/magento indexer:reindex
echo "-|| Flushing"
bin/magento cache:flush